<!DOCTYPE html>

<html>
<head>
  <title>serviceWorker.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="App.html">
                  src/App.js
                </a>
              
                
                <a class="source" href="Counter.html">
                  src/Counter.js
                </a>
              
                
                <a class="source" href="index.html">
                  src/index.js
                </a>
              
                
                <a class="source" href="serviceWorker.html">
                  src/serviceWorker.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>serviceWorker.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>In production, we register a service worker to serve assets from local cache.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This lets the app load faster on subsequent visits in production, and gives
it offline capabilities. However, it also means that developers (and users)
will only see deployed updates on the “N+1” visit to a page, since previously
cached resources are updated in the background.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>To learn more about the benefits of this model, read <a href="https://goo.gl/KwvDNy">https://goo.gl/KwvDNy</a>.
This link also includes instructions on opting out of this behavior.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">const</span> isLocalhost = <span class="hljs-built_in">Boolean</span>(
  <span class="hljs-built_in">window</span>.location.hostname === <span class="hljs-string">'localhost'</span> ||</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>[::1] is the IPv6 localhost address.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">window</span>.location.hostname === <span class="hljs-string">'[::1]'</span> ||</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>127.0.0.1/8 is considered localhost for IPv4.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">window</span>.location.hostname.match(
      <span class="hljs-regexp">/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/</span>
    )
);

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span>(<span class="hljs-params">config</span>) </span>{
  <span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">'production'</span> &amp;&amp; <span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The URL constructor is available in all browsers that support SW.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> publicUrl = <span class="hljs-keyword">new</span> URL(process.env.PUBLIC_URL, <span class="hljs-built_in">window</span>.location);
    <span class="hljs-keyword">if</span> (publicUrl.origin !== <span class="hljs-built_in">window</span>.location.origin) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Our service worker won’t work if PUBLIC_URL is on a different origin
from what our page is served on. This might happen if a CDN is used to
serve assets; see <a href="https://github.com/facebook/create-react-app/issues/2374">https://github.com/facebook/create-react-app/issues/2374</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'load'</span>, () =&gt; {
      <span class="hljs-keyword">const</span> swUrl = <span class="hljs-string">`<span class="hljs-subst">${process.env.PUBLIC_URL}</span>/service-worker.js`</span>;

      <span class="hljs-keyword">if</span> (isLocalhost) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>This is running on localhost. Let’s check if a service worker still exists or not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        checkValidServiceWorker(swUrl, config);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Add some additional logging to localhost, pointing developers to the
service worker/PWA documentation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        navigator.serviceWorker.ready.then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-built_in">console</span>.log(
            <span class="hljs-string">'This web app is being served cache-first by a service '</span> +
              <span class="hljs-string">'worker. To learn more, visit https://goo.gl/SC7cgQ'</span>
          );
        });
      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Is not local host. Just register service worker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        registerValidSW(swUrl, config);
      }
    });
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerValidSW</span>(<span class="hljs-params">swUrl, config</span>) </span>{
  navigator.serviceWorker
    .register(swUrl)
    .then(<span class="hljs-function"><span class="hljs-params">registration</span> =&gt;</span> {
      registration.onupdatefound = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> installingWorker = registration.installing;
        installingWorker.onstatechange = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (installingWorker.state === <span class="hljs-string">'installed'</span>) {
            <span class="hljs-keyword">if</span> (navigator.serviceWorker.controller) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>At this point, the old content will have been purged and
the fresh content will have been added to the cache.
It’s the perfect time to display a “New content is
available; please refresh.” message in your web app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'New content is available; please refresh.'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Execute callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> (config.onUpdate) {
                config.onUpdate(registration);
              }
            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>At this point, everything has been precached.
It’s the perfect time to display a
“Content is cached for offline use.” message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Content is cached for offline use.'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Execute callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> (config.onSuccess) {
                config.onSuccess(registration);
              }
            }
          }
        };
      };
    })
    .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error during service worker registration:'</span>, error);
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkValidServiceWorker</span>(<span class="hljs-params">swUrl, config</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Check if the service worker can be found. If it can’t reload the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fetch(swUrl)
    .then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Ensure service worker exists, and that we really are getting a JS file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (
        response.status === <span class="hljs-number">404</span> ||
        response.headers.get(<span class="hljs-string">'content-type'</span>).indexOf(<span class="hljs-string">'javascript'</span>) === <span class="hljs-number">-1</span>
      ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>No service worker found. Probably a different app. Reload the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        navigator.serviceWorker.ready.then(<span class="hljs-function"><span class="hljs-params">registration</span> =&gt;</span> {
          registration.unregister().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-built_in">window</span>.location.reload();
          });
        });
      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Service worker found. Proceed as normal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        registerValidSW(swUrl, config);
      }
    })
    .catch(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(
        <span class="hljs-string">'No internet connection found. App is running in offline mode.'</span>
      );
    });
}

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unregister</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
    navigator.serviceWorker.ready.then(<span class="hljs-function"><span class="hljs-params">registration</span> =&gt;</span> {
      registration.unregister();
    });
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
